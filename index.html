<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Master Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            --bg-gradient-start: #1a202c;
            --bg-gradient-end: #111621;
            --text-primary: #d1d5db;
            --text-secondary: #9ca3af;
            --text-accent: #ffffff;
            --ui-bg-primary: rgba(26, 32, 44, 0.7);
            --ui-bg-secondary: #2d3748;
            --ui-bg-hover: #4a5568;
            --border-primary: #4a5568;
            --accent-primary: #60a5fa;
            --accent-secondary: #93c5fd;
            --item-bg: rgba(55, 65, 81, 0.5);
            --item-bg-completed: rgba(45, 55, 72, 0.5);
            --item-header-bg: #28374f;
            --item-unlock-bg: linear-gradient(135deg, #fde047, #facc15);
            --item-unlock-text: #713f12;
        }

        .theme-light {
            --bg-gradient-start: #f9fafb;
            --bg-gradient-end: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-accent: #111827;
            --ui-bg-primary: rgba(255, 255, 255, 0.7);
            --ui-bg-secondary: #f3f4f6;
            --ui-bg-hover: #e5e7eb;
            --border-primary: #d1d5db;
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --item-bg: rgba(59, 130, 246, 0.1);
            --item-bg-completed: rgba(229, 231, 235, 0.8);
            --item-header-bg: #f9fafb;
            --item-unlock-bg: linear-gradient(135deg, #fde047, #facc15);
            --item-unlock-text: #713f12;
        }

        .theme-matcha {
            --bg-gradient-start: #2c3e34;
            --bg-gradient-end: #212e26;
            --text-primary: #d7e5d5;
            --text-secondary: #a2b59f;
            --text-accent: #ffffff;
            --ui-bg-primary: rgba(33, 46, 38, 0.7);
            --ui-bg-secondary: #3e5447;
            --ui-bg-hover: #4f6a58;
            --border-primary: #4f6a58;
            --accent-primary: #86efac;
            --accent-secondary: #bbf7d0;
            --item-bg: rgba(134, 239, 172, 0.15);
            --item-bg-completed: rgba(62, 84, 71, 0.5);
            --item-header-bg: #3e5447;
            --item-unlock-bg: linear-gradient(135deg, #fde047, #facc15);
            --item-unlock-text: #713f12;
        }

        .theme-dusk {
            --bg-gradient-start: #4c334d;
            --bg-gradient-end: #312332;
            --text-primary: #f5e0f5;
            --text-secondary: #d1aed2;
            --text-accent: #ffffff;
            --ui-bg-primary: rgba(49, 35, 50, 0.7);
            --ui-bg-secondary: #6b4b6d;
            --ui-bg-hover: #856187;
            --border-primary: #856187;
            --accent-primary: #f472b6;
            --accent-secondary: #f9a8d4;
            --item-bg: rgba(244, 114, 182, 0.15);
            --item-bg-completed: rgba(107, 75, 109, 0.5);
            --item-header-bg: #6b4b6d;
            --item-unlock-bg: linear-gradient(135deg, #fde047, #facc15);
            --item-unlock-text: #713f12;
        }

        .theme-ocean {
            --bg-gradient-start: #2a3a4a;
            --bg-gradient-end: #1f2937;
            --text-primary: #cdd6e0;
            --text-secondary: #9fb1c6;
            --text-accent: #ffffff;
            --ui-bg-primary: rgba(31, 41, 55, 0.7);
            --ui-bg-secondary: #374151;
            --ui-bg-hover: #4b5563;
            --border-primary: #4b5563;
            --accent-primary: #7dd3fc;
            --accent-secondary: #bae6fd;
            --item-bg: rgba(125, 211, 252, 0.15);
            --item-bg-completed: rgba(55, 65, 81, 0.5);
            --item-header-bg: #374151;
            --item-unlock-bg: linear-gradient(135deg, #fde047, #facc15);
            --item-unlock-text: #713f12;
        }

        .theme-purple {
            --bg-gradient-start: #1e293b;
            --bg-gradient-end: #4c1d95;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-accent: #ffffff;
            --ui-bg-primary: rgba(17, 24, 39, 0.7);
            --ui-bg-secondary: #374151;
            --ui-bg-hover: #4b5563;
            --border-primary: #4b5563;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --item-bg: rgba(79, 70, 229, 0.3);
            --item-bg-completed: rgba(55, 65, 81, 0.5);
            --item-header-bg: #1f2937;
            --item-unlock-bg: linear-gradient(135deg, #fde047, #facc15);
            --item-unlock-text: #713f12;
        }

        .step-item { transition: all 0.3s ease; }
        .sortable-ghost { background: #eef2ff; opacity: 0.7; border: 2px dashed #6366f1; }
        .sortable-drag { opacity: 1 !important; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="text-[color:var(--text-primary)] bg-gradient-to-br" style="background-color: var(--bg-gradient-end); background-image: linear-gradient(to bottom right, var(--bg-gradient-start), var(--bg-gradient-end));">
    <div class="absolute top-4 right-4">
        <div class="relative" id="theme-selector-container">
            <button id="theme-toggle-btn" class="flex items-center space-x-2 px-3 py-2 bg-[color:var(--ui-bg-secondary)] rounded-lg border border-[color:var(--border-primary)] hover:bg-[color:var(--ui-bg-hover)] transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-[color:var(--accent-primary)]">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>
                <span id="current-theme-name" class="text-sm font-medium text-[color:var(--text-primary)]">Slate</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[color:var(--text-secondary)]"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
            <div id="theme-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-[color:var(--ui-bg-primary)] backdrop-blur-sm rounded-lg shadow-lg border border-[color:var(--border-primary)] z-10 py-1">
                <button data-theme="theme-light" class="w-full text-left px-4 py-2 text-sm text-[color:var(--text-primary)] hover:bg-[color:var(--ui-bg-hover)]">Light</button>
                <button data-theme="slate" class="w-full text-left px-4 py-2 text-sm text-[color:var(--text-primary)] hover:bg-[color:var(--ui-bg-hover)]">Slate</button>
                <button data-theme="theme-purple" class="w-full text-left px-4 py-2 text-sm text-[color:var(--text-primary)] hover:bg-[color:var(--ui-bg-hover)]">Purple Night</button>
                <button data-theme="theme-matcha" class="w-full text-left px-4 py-2 text-sm text-[color:var(--text-primary)] hover:bg-[color:var(--ui-bg-hover)]">Matcha</button>
                <button data-theme="theme-dusk" class="w-full text-left px-4 py-2 text-sm text-[color:var(--text-primary)] hover:bg-[color:var(--ui-bg-hover)]">Dusk</button>
                <button data-theme="theme-ocean" class="w-full text-left px-4 py-2 text-sm text-[color:var(--text-primary)] hover:bg-[color:var(--ui-bg-hover)]">Ocean</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-3xl px-4 py-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-[color:var(--text-accent)] tracking-tight">Grid Master Planner</h1>
            <p class="mt-3 text-lg text-[color:var(--text-secondary)]">Create your most Tylenol-inspired Grid Master start</p>
        </header>

        <div class="bg-[color:var(--ui-bg-primary)] backdrop-blur-sm rounded-xl shadow-lg p-6 md:p-8 mb-8 border border-[color:var(--border-primary)]">
            <form id="add-step-form" class="space-y-4">
                <div>
                    <label for="step-text" class="block text-sm font-medium text-[color:var(--text-secondary)] mb-1">New Item</label>
                    <input type="text" id="step-text" placeholder="e.g., 'Complete Tutorial Island' or 'Cut some maple logs'" class="w-full px-4 py-2 bg-[color:var(--ui-bg-secondary)] border border-[color:var(--border-primary)] rounded-lg focus:ring-2 focus:ring-[color:var(--accent-primary)] focus:border-[color:var(--accent-primary)] transition text-[color:var(--text-primary)]">
                </div>
                <div class="flex items-center justify-between flex-wrap gap-4">
                     <fieldset class="flex items-center gap-x-4 md:gap-x-6">
                        <legend class="sr-only">Item Type</legend>
                        <div class="flex items-center">
                            <input id="type-step" name="item-type" type="radio" value="step" checked class="h-4 w-4 text-[color:var(--accent-primary)] focus:ring-[color:var(--accent-primary)] border-[color:var(--border-primary)] bg-[color:var(--ui-bg-secondary)]">
                            <label for="type-step" class="ml-2 text-sm text-[color:var(--text-primary)]">Step</label>
                        </div>
                        <div class="flex items-center">
                            <input id="type-header" name="item-type" type="radio" value="header" class="h-4 w-4 text-[color:var(--accent-primary)] focus:ring-[color:var(--accent-primary)] border-[color:var(--border-primary)] bg-[color:var(--ui-bg-secondary)]">
                            <label for="type-header" class="ml-2 text-sm text-[color:var(--text-primary)]">Section Header</label>
                        </div>
                        <div class="flex items-center">
                            <input id="type-unlock" name="item-type" type="radio" value="unlock" class="h-4 w-4 text-[color:var(--accent-primary)] focus:ring-[color:var(--accent-primary)] border-[color:var(--border-primary)] bg-[color:var(--ui-bg-secondary)]">
                            <label for="type-unlock" class="ml-2 text-sm text-[color:var(--text-primary)]">Tile Unlock</label>
                        </div>
                    </fieldset>
                    <button type="submit" class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-[color:var(--accent-primary)] hover:bg-[color:var(--accent-secondary)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-[color:var(--accent-primary)] transition">
                        Add to Plan
                    </button>
                </div>
            </form>
        </div>

        <div id="plan-container" class="bg-[color:var(--ui-bg-primary)] backdrop-blur-sm rounded-xl shadow-lg p-6 md:p-8 border border-[color:var(--border-primary)]">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-[color:var(--text-accent)]">Your Route</h2>
                    <span class="text-sm text-[color:var(--text-secondary)]">Drag to reorder, double-click to edit</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="import-btn" title="Import Plan" class="flex items-center space-x-2 px-3 py-1.5 text-sm bg-[color:var(--ui-bg-secondary)] rounded-lg border border-[color:var(--border-primary)] hover:bg-[color:var(--ui-bg-hover)] transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-[color:var(--accent-primary)]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <span>Import</span>
                    </button>
                    <button id="export-btn" title="Export Plan" class="flex items-center space-x-2 px-3 py-1.5 text-sm bg-[color:var(--ui-bg-secondary)] rounded-lg border border-[color:var(--border-primary)] hover:bg-[color:var(--ui-bg-hover)] transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-[color:var(--accent-primary)]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        <span>Export</span>
                    </button>
                </div>
            </div>
            <ul id="plan-list" class="space-y-3">
                <!-- Plan steps will be inserted here --></ul>
            <div id="empty-state" class="text-center py-10 border-2 border-dashed border-[color:var(--border-primary)] rounded-lg mt-4">
                <p class="text-[color:var(--text-secondary)]">Your route is currently empty.</p>
                <p class="text-sm text-[color:var(--text-secondary)]/80 mt-1">Add a step or section header or tile to get started!</p>
            </div>
        </div>

    </div>
    
    <input type="file" id="import-file-input" class="hidden" accept="application/json">

    <script>
        const form = document.getElementById('add-step-form');
        const stepInput = document.getElementById('step-text');
        const planList = document.getElementById('plan-list');
        const emptyState = document.getElementById('empty-state');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeDropdown = document.getElementById('theme-dropdown');
        const currentThemeNameEl = document.getElementById('current-theme-name');
        const body = document.body;
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file-input');

        let plan;
        try {
            const storedPlan = localStorage.getItem('plan');
            plan = storedPlan ? JSON.parse(storedPlan) : [];
            if (!Array.isArray(plan)) plan = [];
            
            // Migration for users from the old data format (isSection)
            if (plan.length > 0 && typeof plan[0].isSection !== 'undefined') {
                plan = plan.map(item => ({
                    text: item.text,
                    type: item.isSection ? 'header' : 'step',
                    completed: item.completed || false
                }));
                savePlan(); // Immediately save back in the new format
            }
        } catch (e) {
            console.error("Could not parse plan from localStorage:", e);
            plan = [];
        }

        function renderPlan() {
            planList.innerHTML = '';

            if (plan.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                const listItemsHTML = plan.map((item, index) => {
                    let liClasses = `step-item flex items-center justify-between p-3 rounded-lg group `;
                    let liStyle = '';
                    let contentHTML = '';

                    const deleteButtonHTML = `
                        <button class="delete-btn text-gray-500 hover:text-red-500 transition p-1 rounded-full hover:bg-[color:var(--ui-bg-hover)]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>`;
                    
                    const dragHandleHTML = `
                        <div class="drag-handle cursor-move text-[color:var(--text-secondary)] hover:text-[color:var(--text-primary)] transition">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                        </div>`;

                    switch (item.type) {
                        case 'header':
                            liClasses += 'bg-[color:var(--item-header-bg)]';
                            contentHTML = `
                                <div class="flex items-center space-x-3 flex-grow">
                                    ${dragHandleHTML}
                                    <h3 class="item-text text-lg font-semibold text-[color:var(--text-accent)] flex-grow cursor-pointer">${item.text}</h3>
                                </div>
                                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ${deleteButtonHTML}
                                </div>`;
                            break;

                        case 'unlock':
                            liStyle = `background-image: var(--item-unlock-bg); color: var(--item-unlock-text);`;
                            contentHTML = `
                                <div class="flex items-center space-x-3 flex-grow">
                                    ${dragHandleHTML}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="opacity-80"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>
                                    <h3 class="item-text text-lg font-bold flex-grow cursor-pointer">${item.text}</h3>
                                </div>
                                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ${deleteButtonHTML.replace('text-gray-500', 'text-white/70').replace('hover:text-red-500', 'hover:text-white')}
                                </div>`;
                            break;

                        case 'step':
                        default:
                            const isCompleted = item.completed;
                            liClasses += isCompleted ? 'bg-[color:var(--item-bg-completed)] border border-[color:var(--border-primary)]' : 'bg-[color:var(--item-bg)]';
                            const textClasses = isCompleted ? 'text-[color:var(--text-secondary)] line-through' : 'text-[color:var(--text-primary)]';
                            contentHTML = `
                                <div class="flex items-center space-x-3 flex-grow">
                                    ${dragHandleHTML}
                                    <input type="checkbox" class="toggle-complete h-5 w-5 text-[color:var(--accent-primary)] focus:ring-[color:var(--accent-primary)] border-[color:var(--border-primary)] rounded bg-[color:var(--ui-bg-secondary)]" ${isCompleted ? 'checked' : ''}>
                                    <span class="item-text ${textClasses} flex-grow cursor-pointer">${item.text}</span>
                                </div>
                                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ${deleteButtonHTML}
                                </div>`;
                            break;
                    }
                    
                    return `<li class="${liClasses}" data-index="${index}" style="${liStyle}">${contentHTML}</li>`;
                }).join('');

                planList.innerHTML = listItemsHTML;
            }
        }

        function savePlan() {
            localStorage.setItem('plan', JSON.stringify(plan));
        }
        
        function addStep(e) {
            e.preventDefault();
            const text = stepInput.value.trim();
            if (text === '') return;

            const itemType = document.querySelector('input[name="item-type"]:checked').value;

            const newItem = {
                text,
                type: itemType,
                completed: false
            };

            plan.push(newItem);
            stepInput.value = '';
            document.getElementById('type-step').checked = true;
            
            savePlan();
            renderPlan();
        }

        function deleteStep(index) {
            plan.splice(index, 1);
            savePlan();
            renderPlan();
        }

        function toggleComplete(index) {
            if (plan[index] && plan[index].type === 'step') {
                plan[index].completed = !plan[index].completed;
                savePlan();
                renderPlan();
            }
        }

        function editStep(li, index) {
            const itemTextElement = li.querySelector('.item-text');
            if (!itemTextElement) return;

            const currentText = plan[index].text;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'w-full px-1 py-0 bg-[color:var(--ui-bg-secondary)] border border-[color:var(--accent-primary)] rounded-md focus:ring-1 focus:ring-[color:var(--accent-primary)] focus:border-[color:var(--accent-primary)] text-[color:var(--text-primary)]';
            if (plan[index].type !== 'step') {
                 input.className += ' text-lg';
            }

            itemTextElement.replaceWith(input);
            input.focus();
            input.select();

            const saveChanges = () => {
                const newText = input.value.trim();
                if (newText) {
                    plan[index].text = newText;
                    savePlan();
                }
                renderPlan();
            };
            
            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveChanges();
                if (e.key === 'Escape') renderPlan();
            });
        }
        
        function getDisplayName(themeName) {
            if (!themeName) return 'Slate';
            return themeName
                .replace('theme-', '')
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function applyTheme(themeName) {
            body.className = body.className.replace(/theme-\w+/g, '');
            if (themeName !== 'slate') {
                body.classList.add(themeName);
            }
            localStorage.setItem('plan-theme', themeName);
            if (currentThemeNameEl) {
                currentThemeNameEl.textContent = getDisplayName(themeName);
            }
        }
        
        function exportPlan() {
            if (plan.length === 0) {
                console.log("Plan is empty, nothing to export.");
                return;
            }
            const planJson = JSON.stringify(plan, null, 2);
            const blob = new Blob([planJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const date = new Date();
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            a.download = `plan-${dateString}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) { return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData) && (importedData.length === 0 || (importedData[0].text && importedData[0].type))) {
                        plan = importedData;
                        savePlan();
                        renderPlan();
                    } else {
                        console.error("Invalid plan file format.");
                    }
                } catch (error) {
                    console.error("Error parsing imported file:", error);
                }
            };
            
            reader.readAsText(file);
            event.target.value = null;
        }

        themeToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            themeDropdown.classList.toggle('hidden');
        });

        themeDropdown.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                applyTheme(e.target.dataset.theme);
                themeDropdown.classList.add('hidden');
            }
        });

        window.addEventListener('click', () => {
            if (!themeDropdown.classList.contains('hidden')) {
                themeDropdown.classList.add('hidden');
            }
        });

        form.addEventListener('submit', addStep);

        planList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const item = deleteBtn.closest('.step-item');
                deleteStep(parseInt(item.dataset.index));
                return;
            }
            
            if (e.target.classList.contains('toggle-complete')) {
                const item = e.target.closest('.step-item');
                toggleComplete(parseInt(item.dataset.index));
            }
        });

        planList.addEventListener('dblclick', (e) => {
            const itemText = e.target.closest('.item-text');
            if (itemText) {
                const li = itemText.closest('.step-item');
                editStep(li, parseInt(li.dataset.index));
            }
        });

        exportBtn.addEventListener('click', exportPlan);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', handleImport);

        // Initial Load
        const savedTheme = localStorage.getItem('plan-theme') || 'slate';
        applyTheme(savedTheme);
        renderPlan();

        // Setup Drag and Drop
        if (typeof Sortable !== 'undefined') {
            new Sortable(planList, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    const [movedItem] = plan.splice(evt.oldIndex, 1);
                    plan.splice(evt.newIndex, 0, movedItem);
                    savePlan();
                    renderPlan();
                },
            });
        } else {
            console.error("Sortable.js library not loaded, drag-and-drop will be disabled.");
        }
    </script>
</body>
</html>


